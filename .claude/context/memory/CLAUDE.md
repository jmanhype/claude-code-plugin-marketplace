<!-- .claude/context/memory/CLAUDE.md -->
<!-- Purpose: Memory model, retrieval algorithm, and feedback integration -->

# Memory Guide

## Files

- `bullets.json` — Authoritative bullet library (seeded with domain knowledge)
- `ratings.jsonl` — Optional user ratings, one JSON per line
- `reports/conflicts.json` — Generated by conflict detector

---

## Retrieval Algorithm

**Purpose:** Rank bullets for a task using **tags + TF-IDF + helpful_count**

### Scoring Formula

```python
Score(bullet, query) =
    2.0 * tag_overlap +
    cosine(tfidf(query), tfidf(bullet.title + content)) +
    0.1 * log1p(helpful_count - harmful_count)
```

**Components:**

1. **Tag overlap** (weight: 2.0) - Number of shared tags between query and bullet
2. **TF-IDF cosine similarity** - Semantic relevance of bullet text to query
3. **Helpfulness prior** (weight: 0.1) - Log-scaled net helpfulness

### Usage

```bash
python skills/ace-context-engineering/scripts/retrieve_bullets.py \
  .claude/context/memory/bullets.json \
  "create YouTube thumbnail" \
  --tags yt.thumbnail,design \
  --topk 10
```

**Output:** Top-K bullets with IDs, titles, and scores

---

## Counters & Feedback

### Execution Feedback

Increment counters using generator output:

```bash
python scripts/update_counters.py bullets.json generator_output.json
```

Generator output must include:
- `used_bullet_ids` - Bullets that were applied
- `bullet_confidence` - Confidence per bullet (0.0-1.0)

### Human Feedback

Append JSON lines to `ratings.jsonl`:

```json
{"type":"user_rating","bullet_id":"yt-thumb-contrast-001","value":1,"note":"Clear CTR uplift"}
{"type":"exec_failure","bullet_id":"yt-prompt-nanoban-002","value":-1,"note":"Cluttered output"}
```

Then apply ratings:

```bash
python scripts/update_counters.py bullets.json gen_output.json --ratings ratings.jsonl
```

---

## Delta Lifecycle

1. **Generator** produces strict JSON with final_answer and used_bullet_ids
2. **Reflector** proposes `proposed_deltas` based on outcomes
3. **Curator** outputs `clean_delta` after normalization/dedup
4. **Validate** → `validate_delta.py delta clean_delta.json`
5. **Merge** → `merge_deltas.py bullets.json clean_delta.json bullets_updated.json`
6. **Optional:** `detect_conflicts.py` to surface contradictory guidance

---

## Memory Model

### Short-term Memory (Conversation Context)

- Current session only
- Tool invocations and results
- Task progress and temporary decisions

### Long-term Memory (Persistent Context)

- `bullets.json` - Cross-session, project-wide knowledge
- Version-controlled in `.claude/context/memory/`
- Evolves via ACE delta merges

---

## Retrieval Policy

### When to Retrieve

1. **Task initiation** - Load relevant bullets before execution
2. **Uncertainty** - When facing ambiguity or unfamiliar patterns
3. **Failure recovery** - After errors, retry with different bullets
4. **Domain switch** - When moving to different codebase area

### Retrieval Priorities

1. **Task-specific context** - Bullets with matching domain tags
2. **High-confidence bullets** - confidence > 0.7
3. **Proven patterns** - helpful_count > harmful_count
4. **Prerequisites met** - Check bullet dependencies

---

## Counter Management

### Bullet Effectiveness Counters

Each bullet tracks:

- `helpful_count` - Incremented when bullet contributed to success
- `harmful_count` - Incremented when bullet led to errors
- `confidence` - 0.0-1.0 based on evidence strength
- `last_updated` - Timestamp of last modification

### When to Update Counters

- ✅ After task completion - mark helpful bullets
- ✅ After errors - mark misleading bullets
- ✅ During reflection - assess guidance value
- ⚠️ Be conservative - only update when causation is clear

### Counter Decay

- Bullets with `harmful_count > helpful_count` → candidates for review
- Low `helpful_count` after many uses → may be deprecated
- Recent bullets need more evidence before high confidence

---

## Memory Hygiene

### Keep Current

- Remove/deprecate obsolete guidance after major refactors
- Update tool usage notes when APIs change
- Refresh project context when architecture evolves

### Avoid Bloat

- Merge redundant bullets via ACE deltas
- Archive rarely-used but historically important bullets
- Prefer links to external docs over embedding full specs

### Version Control

- All memory changes version-controlled via git
- Significant changes include clear commit messages
- Breaking changes require user approval

---

## End-to-End Walkthrough

See `.claude/docs/walkthroughs/ace_cycle_example.md` for complete example:
- YouTube thumbnail generation task
- Generator→Reflector→Curator flow
- Delta merge and counter updates
- Real JSON outputs at each stage

---

**Last Updated**: 2025-10-25
